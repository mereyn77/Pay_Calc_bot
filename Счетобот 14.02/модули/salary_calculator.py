import pandas as pd
import numpy as np

class SalaryCalculator:
    def __init__(self, norm_hours=168):
        print(f"üéØ DEBUG: SalaryCalculator.__init__() –≤—ã–∑–≤–∞–Ω")
        print(f"üéØ DEBUG: self = {id(self)}")
        print(f"üéØ DEBUG: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é self.problems = []")
        
        self.default_norm_hours = norm_hours
        self.problems = []
        self.problem_departments = set()

        print(f"üéØ DEBUG: self.problems —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {self.problems}")
        print(f"üéØ DEBUG: hasattr(self, 'problems'): {hasattr(self, 'problems')}")
        
    def add_problem(self, dept, fio, message):
        """–î–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –≤ —Å–ø–∏—Å–æ–∫"""
        problem = {
            '–û—Ç–¥–µ–ª': dept,
            '–§–ò–û': fio,
            '–ü—Ä–æ–±–ª–µ–º–∞': message,
            '–¢–∏–ø': 'warning' if '—á–∞—Å–æ–≤' in message else 'error'
        }
        self.problems.append(problem)  # self.problems –î–û–õ–ñ–ï–ù –°–£–©–ï–°–¢–í–û–í–ê–¢–¨
        self.problem_departments.add(dept)
        
    def get_problems_summary(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–≤–æ–¥–∫—É –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º"""
        if not self.problems:  # self.problems –î–û–õ–ñ–ï–ù –°–£–©–ï–°–¢–í–û–í–ê–¢–¨
            return None
            
        summary = {
            'total_problems': len(self.problems),
            'problem_departments': len(self.problem_departments),
            'problems_by_type': {},
            'problem_list': self.problems
        }
        
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø—É
        for problem in self.problems:  # self.problems –î–û–õ–ñ–ï–ù –°–£–©–ï–°–¢–í–û–í–ê–¢–¨
            ptype = problem['–¢–∏–ø']
            summary['problems_by_type'][ptype] = summary['problems_by_type'].get(ptype, 0) + 1
            
        return summary
        
    def calculate_salary(self, integrated_df, office_norm_hours=168):
        """
        –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê –ø–æ –æ—Ç—á–µ—Ç—É:
        
        –≠–¢–ê–ü 1: –ö–æ—Ç–µ–ª = Œ£(–°—Ä–µ–¥–Ω—è—è_–ó–ü - –û–∫–ª–∞–¥)
        –≠–¢–ê–ü 2: –õ–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å = –ø—Ä–∏–±—ã–ª–∏/–ø—Ä–æ–¥–∞–∂–∏ √ó –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
        –≠–¢–ê–ü 3: –î–æ–ª—è = –õ–∏—á–Ω—ã–π_–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å / Œ£(–õ–∏—á–Ω—ã–µ_–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏)
        –≠–¢–ê–ü 4: –û–∫–ª–∞–¥–Ω–∞—è —á–∞—Å—Ç—å = –û–∫–ª–∞–¥ √ó (–ß–∞—Å—ã / –ù–æ—Ä–º–∞)
        –≠–¢–ê–ü 5: –ó–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤ = –î–æ–ª_–ø—Ä–µ–º + –û–∫–ª–∞–¥–Ω–∞—è_—á–∞—Å—Ç—å
        –≠–¢–ê–ü 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª–∫–∏
        –≠–¢–ê–ü 7: –ü—Ä–µ–º–∏—è –ª–∏–¥–µ—Ä–∞–º (—Ç–æ–ø-3)
        """
        print("\n" + "="*60)
        print("–ù–û–í–´–ô –†–ê–°–ß–ï–¢ –ó–ê–†–ü–õ–ê–¢–´ (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞)")
        print("="*60)
        
        if integrated_df.empty:
            print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞")
            return None
        
        df = integrated_df.copy()
        results_by_dept = {}
        all_results = []
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –æ—Ç–¥–µ–ª
        for dept in df['–û—Ç–¥–µ–ª'].unique():
            if dept == '–ù–µ —É–∫–∞–∑–∞–Ω':
                continue
                
            dept_df = df[df['–û—Ç–¥–µ–ª'] == dept]
            if dept_df.empty:
                continue
            
            print(f"\nüìÅ –û—Ç–¥–µ–ª: {dept}")
            dept_results = self._calculate_for_department(dept, dept_df, office_norm_hours)
            
            if dept_results is None:
                print(f"  ‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω –æ—Ç–¥–µ–ª –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ —Ä–∞—Å—á–µ—Ç–∞")
                continue
            
            results_by_dept[dept] = dept_results
            all_results.extend(dept_results)
        
        if all_results:
            results_df = pd.DataFrame(all_results)
            
            # –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—Ç–¥–µ–ª—É –∏ —Ä–µ–π—Ç–∏–Ω–≥—É (—É–±—ã–≤–∞–Ω–∏–µ)
            results_df = results_df.sort_values(['–û—Ç–¥–µ–ª', '–î–æ–ª—è'], ascending=[True, False])
            
            print(f"\n‚úÖ –†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")
            print(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ—Ç–¥–µ–ª–æ–≤: {len(results_by_dept)}")
            print(f"üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {len(results_df)}")
            
            # –ü–æ–ª—É—á–∞–µ–º —Å–≤–æ–¥–∫—É –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º
            problems_summary = self.get_problems_summary()

            self.calculations = {
                'by_employee': results_df,
                'by_department': results_by_dept,
                'summary': {
                    'total_salary': results_df['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'].sum(),
                    'avg_salary': results_df['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'].mean(),
                    'total_employees': len(results_df),
                    'total_departments': len(results_by_dept)
                },
                'problems': problems_summary  # –ù–æ–≤–æ–µ: –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—ã
            }

            # –í—ã–≤–æ–¥–∏–º –ø—Ä–æ–±–ª–µ–º—ã –µ—Å–ª–∏ –µ—Å—Ç—å
            if problems_summary:
                print(f"\n‚ö†Ô∏è  –ù–ê–ô–î–ï–ù–´ –ü–†–û–ë–õ–ï–ú–´:")
                print(f"   –í—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º: {problems_summary['total_problems']}")
                print(f"   –ó–∞—Ç—Ä–æ–Ω—É—Ç–æ –æ—Ç–¥–µ–ª–æ–≤: {problems_summary['problem_departments']}")
                
                for ptype, count in problems_summary['problems_by_type'].items():
                    print(f"   {ptype}: {count}")
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 5 –ø—Ä–æ–±–ª–µ–º
                print(f"\n   –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–æ–±–ª–µ–º:")
                for problem in problems_summary['problem_list'][:5]:
                    print(f"   ‚Ä¢ {problem['–§–ò–û']} - {problem['–û—Ç–¥–µ–ª']}: {problem['–ü—Ä–æ–±–ª–µ–º–∞']}")

            # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            self.print_results(self.calculations)

            return self.calculations
        
        return None
        

    def _calculate_for_department(self, dept_name, dept_df, office_norm_hours):
        """
        –†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –ø–æ –ù–û–í–û–ô 12-—ç—Ç–∞–ø–Ω–æ–π —Å—Ö–µ–º–µ
        
        –≠–¢–ê–ü 1:  –ö–æ—Ç–µ–ª = Œ£(–°—Ä–µ–¥–Ω—è—è_–ó–ü - –ë–∞–∑–æ–≤–∞—è_—á–∞—Å—Ç—å)
        –≠–¢–ê–ü 2:  –õ–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (—Ç–æ–ª—å–∫–æ "—Ä–æ–∑–Ω–∏—á–Ω–∞—è –ø–æ —á–µ–∫–∞–º")
        –≠–¢–ê–ü 3:  –î–æ–ª—è = –õ–∏—á–Ω—ã–π_–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å / Œ£(–õ–∏—á–Ω—ã–µ_–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏)
        –≠–¢–ê–ü 4:  –î–æ–ª–µ–≤–∞—è –ø—Ä–µ–º–∏—è = –ö–æ—Ç–µ–ª √ó –î–æ–ª—è
        –≠–¢–ê–ü 5:  –ó–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤ = –î–æ–ª_–ø—Ä–µ–º
        –≠–¢–ê–ü 6:  + –û–ø—Ç–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏
        –≠–¢–ê–ü 7:  + "–†–æ–∑–Ω–∏—á–Ω–∞—è –ø—Ä–æ—á–∞—è" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞–∫ —É –æ–ø—Ç–æ–≤—ã—Ö)
        –≠–¢–ê–ü 8:  + –û–∫–ª–∞–¥ (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ —á–∞—Å–∞–º)
        –≠–¢–ê–ü 9:  –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª–∫–∏ (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ —á–∞—Å–∞–º)
        –≠–¢–ê–ü 10: –ì–∞—Ä–∞–Ω—Ç–∏–∏ —Ç–æ–ø-3 (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ —á–∞—Å–∞–º)
        –≠–¢–ê–ü 11: –†–∞–∑–Ω–∏—Ü–∞ –ø–æ —á–∞—Å–∞–º (–¥–ª—è –æ—Ç—á–µ—Ç–∞)
        """

        # –û—Ç–ª–∞–¥–∫–∞ –¥–ª—è –æ—Ç–¥–µ–ª–∞ "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞ —Å–∞–Ω—Ñ–∞—è–Ω—Å –ë–î1"
        if dept_name == "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞ —Å–∞–Ω—Ñ–∞—è–Ω—Å –ë–î1":
            print("\n" + "="*80)
            print(f"üîçüîçüîç –û–¢–õ–ê–î–ö–ê –†–ê–°–ß–ï–¢–ê –î–õ–Ø –û–¢–î–ï–õ–ê: {dept_name}")
            print("="*80)
            print(f"–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ—Ç–¥–µ–ª–µ: {len(dept_df)}")
            print(f"–ü–µ—Ä–≤—ã–µ 5 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:")
            for i, (_, emp) in enumerate(dept_df.head(5).iterrows()):
                print(f"  {i+1}. {emp['–§–ò–û']}: –ß–∞—Å—ã={emp.get('–ß–∞—Å—ã_–≤—Å–µ–≥–æ', 0)}, "
                      f"–í—ã—Ä—É—á–∫–∞={emp.get('–í—ã—Ä—É—á–∫–∞', 0):,.0f}, "
                      f"–ü—Ä–∏–±—ã–ª—å={emp.get('–ü—Ä–∏–±—ã–ª—å', 0):,.0f}")
        
        results = []
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–±–ª–µ–º
        for _, emp in dept_df.iterrows():
            fio = emp['–§–ò–û']
            hours = float(emp.get('–ß–∞—Å—ã_–≤—Å–µ–≥–æ', 0))
            
            if hours == 0:
                self.add_problem(dept_name, fio, "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —á–∞—Å–∞–º (—á–∞—Å—ã = 0)")
            elif hours < 0:
                self.add_problem(dept_name, fio, f"–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∞—Å–æ–≤: {hours}")
            elif hours > 300:
                self.add_problem(dept_name, fio, f"–ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –º–Ω–æ–≥–æ —á–∞—Å–æ–≤: {hours}")
            
            revenue = float(emp.get('–í—ã—Ä—É—á–∫–∞', 0))
            profit = float(emp.get('–ü—Ä–∏–±—ã–ª—å', 0))
            
            if hours > 0 and revenue == 0 and profit == 0:
                self.add_problem(dept_name, fio, "–ï—Å—Ç—å —á–∞—Å—ã, –Ω–æ –Ω–µ—Ç –ø—Ä–æ–¥–∞–∂")
            if profit < 0:
                self.add_problem(dept_name, fio, f"–û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∏–±—ã–ª—å: {profit}")
                
            norm_hours = float(emp.get('–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤', 0))
            if norm_hours == 0:
                self.add_problem(dept_name, fio, "–ù–æ—Ä–º–∞ —á–∞—Å–æ–≤ = 0")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        required_cols = ['–°—Ä–µ–¥–Ω—è—è_–ó–ü', '–ë–∞–∑–æ–≤–∞—è_—á–∞—Å—Ç—å', '–ú–∏–Ω–∏–º–∞–ª–∫–∞_–æ—Ç–¥–µ–ª–∞', '–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤', '–û–∫–ª–∞–¥']
        missing_cols = [col for col in required_cols if col not in dept_df.columns]
        if missing_cols:
            error_msg = f"–ù–µ—Ç –∫–æ–ª–æ–Ω–æ–∫: {missing_cols}"
            print(f"  ‚ùå {error_msg}")
            self.add_problem(dept_name, "–í–°–ï", error_msg)
            return results
        
        first_row = dept_df.iloc[0]
        avg_salary = float(first_row['–°—Ä–µ–¥–Ω—è—è_–ó–ü'])
        base_part = float(first_row['–ë–∞–∑–æ–≤–∞—è_—á–∞—Å—Ç—å'])  # –ë—ã–≤—à–∏–π "–û–∫–ª–∞–¥"
        min_salary = float(first_row['–ú–∏–Ω–∏–º–∞–ª–∫–∞_–æ—Ç–¥–µ–ª–∞'])
        norm_hours = float(first_row['–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤'])
        –æ–∫–ª–∞–¥_I2 = float(first_row['–û–∫–ª–∞–¥'])  # –ù–æ–≤–æ–µ –ø–æ–ª–µ –∏–∑ —è—á–µ–π–∫–∏ I2
        
        print(f"  üè∫ –û—Ç–¥–µ–ª: {dept_name}")
        print(f"    –ë–∞–∑–æ–≤–∞—è —á–∞—Å—Ç—å: {base_part:,.0f} —Ä—É–±.")
        print(f"    –û–∫–ª–∞–¥ (I2): {–æ–∫–ª–∞–¥_I2:,.0f} —Ä—É–±.")
        print(f"    –°—Ä–µ–¥–Ω—è—è –ó–ü: {avg_salary:,.0f} —Ä—É–±.")
        
        # ===== –≠–¢–ê–ü 1: –ö–û–¢–ï–õ –û–¢–î–ï–õ–ê =====
        department_boiler = 0
        for _, emp in dept_df.iterrows():
            avg = float(emp['–°—Ä–µ–¥–Ω—è—è_–ó–ü'])
            base = float(emp['–ë–∞–∑–æ–≤–∞—è_—á–∞—Å—Ç—å'])
            department_boiler += max(0, avg - base)

        # ===== –ö–û–†–†–ï–ö–¶–ò–Ø –ö–û–¢–õ–ê –ü–û –í–´–†–ê–ë–û–¢–ö–ï –ß–ê–°–û–í =====  ‚Üê –í–°–¢–ê–í–¨ –ó–î–ï–°–¨
        # –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é –≤—ã—Ä–∞–±–æ—Ç–∫—É –æ—Ç–¥–µ–ª–∞
        total_hours_dept = dept_df['–ß–∞—Å—ã_–≤—Å–µ–≥–æ'].sum()
        total_norm_dept = dept_df['–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤'].sum()

        if total_norm_dept > 0:
            percent_completed = (total_hours_dept / total_norm_dept) * 100
            
            # –ï—Å–ª–∏ –≤—ã—Ä–∞–±–æ—Ç–∫–∞ –º–µ–Ω—å—à–µ 90% –Ω–æ—Ä–º—ã - —É–º–µ–Ω—å—à–∞–µ–º –∫–æ—Ç–µ–ª –Ω–∞ 10%
            if percent_completed < 90:
                old_boiler = department_boiler
                department_boiler = department_boiler * 0.9
                reduction = old_boiler - department_boiler
                print(f"    ‚ö†Ô∏è  –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –∫–æ—Ç–ª–∞: –≤—ã—Ä–∞–±–æ—Ç–∫–∞ {percent_completed:.1f}% < 90%")
                print(f"       –ë—ã–ª–æ: {old_boiler:,.0f} —Ä—É–±. ‚Üí –°—Ç–∞–ª–æ: {department_boiler:,.0f} —Ä—É–±.")
                print(f"       –£–º–µ–Ω—å—à–µ–Ω–∏–µ: {reduction:,.0f} —Ä—É–±. (-10%)")
        
        print(f"    –ö–æ—Ç–µ–ª –æ—Ç–¥–µ–ª–∞: {department_boiler:,.0f} —Ä—É–±.")
        
        # ===== –≠–¢–ê–ü 2: –õ–ò–ß–ù–´–ï –ü–û–ö–ê–ó–ê–¢–ï–õ–ò (—Ç–æ–ª—å–∫–æ "—Ä–æ–∑–Ω–∏—á–Ω–∞—è –ø–æ —á–µ–∫–∞–º") =====
        personal_scores = {}
        employee_details = {}
        total_personal_score = 0
        
        for _, emp in dept_df.iterrows():
            fio = emp['–§–ò–û']
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö (–Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
            sales_data = emp.get('–î–∞–Ω–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂')
            if sales_data is None or not isinstance(sales_data, dict):
                # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –∏–ª–∏ —ç—Ç–æ –Ω–µ —Å–ª–æ–≤–∞—Ä—å, —Å–æ–∑–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                sales_data = {
                    '–ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏': {},
                    '–ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç': {},
                    '–ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è': {}
                }
    
            # –ü—Ä–æ–¥–∞–∂–∏ "—Ä–æ–∑–Ω–∏—á–Ω–∞—è –ø–æ —á–µ–∫–∞–º" (–¥–ª—è –ª–∏—á–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è)
            –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏ = sales_data.get('–ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏', {})
            
            # –ü—Ä–æ–¥–∞–∂–∏ –æ–ø—Ç–æ–≤—ã–µ
            –ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç = sales_data.get('–ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç', {})
            
            # –ü—Ä–æ–¥–∞–∂–∏ "—Ä–æ–∑–Ω–∏—á–Ω–∞—è –ø—Ä–æ—á–∞—è"
            –ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è = sales_data.get('–ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è', {})
            
            # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (—É–∂–µ –ø–æ–¥–µ–ª–µ–Ω—ã –Ω–∞ 100 –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä–µ)
            coeff_regular = float(emp.get('–ö–æ—ç—Ñ_–æ–±—ã—á–Ω—ã—Ö', 0.0)) / 100
            coeff_bonus = float(emp.get('–ö–æ—ç—Ñ_–±–æ–Ω—É—Å–Ω—ã—Ö', 0.0)) / 100
            coeff_illiquid = float(emp.get('–ö–æ—ç—Ñ_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤', 0.0)) / 100
            
            # –î–∞–Ω–Ω—ã–µ –∏–∑ "—Ä–æ–∑–Ω–∏—á–Ω–æ–π –ø–æ —á–µ–∫–∞–º"
            –ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏ = –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏.get('–ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è', 0)
            –ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏ = –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏.get('–ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è', 0)
            –≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏ = –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏.get('–≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤', 0)
            
            # –î–∞–Ω–Ω—ã–µ –∏–∑ –æ–ø—Ç–æ–≤—ã—Ö –ø—Ä–æ–¥–∞–∂
            –ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è = –ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç.get('–ø—Ä–∏–±—ã–ª—å', 0)
            
            # –î–∞–Ω–Ω—ã–µ –∏–∑ "—Ä–æ–∑–Ω–∏—á–Ω–æ–π –ø—Ä–æ—á–µ–π"
            –ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è = –ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è.get('–ø—Ä–∏–±—ã–ª—å', 0)
            
            # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ–ø—Ç–æ–≤—ã—Ö (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –¥–ª—è "—Ä–æ–∑–Ω–∏—á–Ω–æ–π –ø—Ä–æ—á–µ–π")
            coeff_wholesale = float(emp.get('–ö–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö', 0.0)) / 100            
            # –≠–¢–ê–ü 2: –õ–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (–¢–û–õ–¨–ö–û "—Ä–æ–∑–Ω–∏—á–Ω–∞—è –ø–æ —á–µ–∫–∞–º")
            score = (
                –ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏ * coeff_regular +
                –ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏ * coeff_bonus +
                –≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏ * coeff_illiquid
            )
            
            personal_scores[fio] = score
            total_personal_score += score
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏ –¥–ª—è —ç—Ç–∞–ø–æ–≤ 6-7
            employee_details[fio] = {
                '–ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è': –ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è,
                '–ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è': –ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è,
                '–∫–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö': coeff_wholesale,
                '–ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏': –ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏,
                '–ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏': –ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏,
                '–≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏': –≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏,
                '–∫–æ—ç—Ñ_–æ–±—ã—á–Ω—ã—Ö': coeff_regular,
                '–∫–æ—ç—Ñ_–±–æ–Ω—É—Å–Ω—ã—Ö': coeff_bonus,
                '–∫–æ—ç—Ñ_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤': coeff_illiquid
            }
            
            # –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥
            if dept_name == "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞ —Å–∞–Ω—Ñ–∞—è–Ω—Å –ë–î1":
                print(f"\n  üîç {fio}:")
                print(f"    –õ–∏—á–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å (—á–µ–∫–∏): {score:,.0f}")
                print(f"      –û–±—ã—á–Ω—ã–µ: {–ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏:,.0f} √ó {coeff_regular:.3f} = {–ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏ * coeff_regular:,.0f}")
                print(f"      –ë–æ–Ω—É—Å–Ω—ã–µ: {–ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏:,.0f} √ó {coeff_bonus:.3f} = {–ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏ * coeff_bonus:,.0f}")
                print(f"      –ù–µ–ª–∏–∫–≤–∏–¥—ã: {–≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏:,.0f} √ó {coeff_illiquid:.3f} = {–≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏ * coeff_illiquid:,.0f}")
                print(f"    –û–ø—Ç–æ–≤—ã–µ: {–ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è:,.0f} —Ä—É–±. (–¥–æ–±–∞–≤—è—Ç—Å—è –ø–æ–∑–∂–µ)")
                print(f"    –†–æ–∑–Ω. –ø—Ä–æ—á–∞—è: {–ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è:,.0f} —Ä—É–±. (–¥–æ–±–∞–≤—è—Ç—Å—è –ø–æ–∑–∂–µ)")
        
        # ===== –≠–¢–ê–ü–´ 3-11: –†–∞—Å—á–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ =====
        for _, emp in dept_df.iterrows():
            fio = emp['–§–ò–û']
            hours = float(emp.get('–ß–∞—Å—ã_–≤—Å–µ–≥–æ', 0))
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            details = employee_details.get(fio, {})
            
            # –≠–¢–ê–ü 3: –î–æ–ª—è
            score = personal_scores.get(fio, 0)
            rating = score / total_personal_score if total_personal_score > 0 else 0
            
            # –≠–¢–ê–ü 4: –î–æ–ª—è –∫–æ—Ç–ª–∞
            boiler_share = max(0, department_boiler * rating)
            
            # –≠–¢–ê–ü 5: –ó–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤ = –î–æ–ª_–ø—Ä–µ–º
            –∑–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤ = max(0, boiler_share)
            
            # –≠–¢–ê–ü 6: + –û–ø—Ç–æ–≤—ã–µ –ø—Ä–æ–¥–∞–∂–∏
            –ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è = details.get('–ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è', 0)
            –∫–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö = details.get('–∫–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö', 0)
            –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–ø—Ç–æ–º = –∑–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤ + (–ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è * –∫–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö)
            
            # –≠–¢–ê–ü 7: + "–†–æ–∑–Ω–∏—á–Ω–∞—è –ø—Ä–æ—á–∞—è" (–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–∞–∫ —É –æ–ø—Ç–æ–≤—ã—Ö)
            –ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è = details.get('–ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è', 0)
            –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–µ–π = –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–ø—Ç–æ–º + (–ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è * –∫–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö)
            
            # –≠–¢–ê–ü 8: + –û–∫–ª–∞–¥ (–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ —á–∞—Å–∞–º)
            if norm_hours > 0:
                –æ–∫–ª–∞–¥_–∏–Ω–¥ = –æ–∫–ª–∞–¥_I2 * (hours / norm_hours)
            else:
                –æ–∫–ª–∞–¥_–∏–Ω–¥ = 0
                
            –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–∫–ª–∞–¥–æ–º = –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–µ–π + –æ–∫–ª–∞–¥_–∏–Ω–¥
            
            # –≠–¢–ê–ü 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–Ω–∏–º–∞–ª–∫–∏
            if norm_hours > 0:
                –º–∏–Ω–∏–º–∞–ª–∫–∞_–∏–Ω–¥ = min_salary * (hours / norm_hours)
            else:
                –º–∏–Ω–∏–º–∞–ª–∫–∞_–∏–Ω–¥ = 0
                
            –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π = max(–∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–∫–ª–∞–¥–æ–º, –º–∏–Ω–∏–º–∞–ª–∫–∞_–∏–Ω–¥)
            
            # –ì–∞—Ä–∞–Ω—Ç–∏–∏ (–¥–ª—è —ç—Ç–∞–ø–∞ 10)
            –≥–∞—Ä–∞–Ω—Ç–∏—è_1 = float(emp.get('–ì–∞—Ä–∞–Ω—Ç–∏—è_1', 0))
            –≥–∞—Ä–∞–Ω—Ç–∏—è_2 = float(emp.get('–ì–∞—Ä–∞–Ω—Ç–∏—è_2', 0))
            –≥–∞—Ä–∞–Ω—Ç–∏—è_3 = float(emp.get('–ì–∞—Ä–∞–Ω—Ç–∏—è_3', 0))
            –≥–∞—Ä–∞–Ω—Ç–∏—è_4 = float(emp.get('–ì–∞—Ä–∞–Ω—Ç–∏—è_4', 0))
            –≥–∞—Ä–∞–Ω—Ç–∏—è_5 = float(emp.get('–ì–∞—Ä–∞–Ω—Ç–∏—è_5', 0))
            
            # –ü–æ–∫–∞ —Å—Ç–∞–≤–∏–º 0, —ç—Ç–∞–ø 10 –≤—ã–ø–æ–ª–Ω–∏–º –ø–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è = 0
            –ø—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è = 0
            –º–µ—Å—Ç–æ = 0
            
            # –ò—Ç–æ–≥–æ–≤–∞—è –ø–æ–∫–∞ –±–µ–∑ –≥–∞—Ä–∞–Ω—Ç–∏–π
            –∏—Ç–æ–≥–æ–≤–∞—è_–∑–∞—Ä–ø–ª–∞—Ç–∞ = –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π
            
            # –≠–¢–ê–ü 11: –†–∞—Å—á–µ—Ç —Ä–∞–∑–Ω–∏—Ü—ã –ø–æ —á–∞—Å–∞–º (–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ)
            —Ä–∞–∑–Ω–∏—Ü–∞_–ø–æ_—á–∞—Å–∞–º = 0
            
            # --- –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –î–õ–Ø –ó–ê–ö–ê–ó–ù–´–• –¢–û–í–ê–†–û–í (–î–û –°–õ–û–í–ê–†–Ø!) ---
            –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏ = details.get('–ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏', {})
            –ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç = details.get('–ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç', {})
            –ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è = details.get('–ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è', {})
            
            # –î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–∫–∞–∑–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º - –ë–ï–ó–û–ü–ê–°–ù–û
            zakaz_data = emp.get('–ó–∞–∫–∞–∑–Ω—ã–µ_–¥–∞–Ω–Ω—ã–µ')
            if zakaz_data is None or not isinstance(zakaz_data, dict):
                zakaz_data = {}
            
            ordered_data = zakaz_data.get('ordered', {}) or {}
            unordered_data = zakaz_data.get('unordered', {}) or {}
            # --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ü–û–õ–£–ß–ï–ù–ò–Ø –î–ê–ù–ù–´–• ---
            
            # --- –¢–ï–ü–ï–†–¨ –°–û–ó–î–ê–ï–ú –°–õ–û–í–ê–†–¨ ---
            result = {
                '–§–ò–û': fio,
                '–§–∏–ª–∏–∞–ª': emp.get('–§–∏–ª–∏–∞–ª', ''),
                '–û—Ç–¥–µ–ª': dept_name,
                '–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ_—á–∞—Å–æ–≤': hours,
                '–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤': norm_hours,
                '–í—ã—Ä—É—á–∫–∞_–≤—Å–µ–≥–æ': float(emp.get('–í—ã—Ä—É—á–∫–∞', 0)),
                '–ü—Ä–∏–±—ã–ª—å_–≤—Å–µ–≥–æ': float(emp.get('–ü—Ä–∏–±—ã–ª—å', 0)),
                
                # –ü—Ä–æ–¥–∞–∂–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                '–û–±—ã—á–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏': details.get('–ø—Ä–∏–±—ã–ª—å_–æ–±—ã—á–Ω–∞—è_—á–µ–∫–∏', 0),
                '–ë–æ–Ω—É—Å–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏': details.get('–ø—Ä–∏–±—ã–ª—å_–±–æ–Ω—É—Å–Ω–∞—è_—á–µ–∫–∏', 0),
                '–ù–µ–ª–∏–∫–≤–∏–¥–Ω–∞—è_–≤—ã—Ä—É—á–∫–∞_—á–µ–∫–∏': details.get('–≤—ã—Ä—É—á–∫–∞_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤_—á–µ–∫–∏', 0),
                '–û–ø—Ç–æ–≤–∞—è_–ø—Ä–∏–±—ã–ª—å': details.get('–ø—Ä–∏–±—ã–ª—å_–æ–ø—Ç–æ–≤–∞—è', 0),
                '–†–æ–∑–Ω_–ø—Ä–æ—á–∞—è_–ø—Ä–∏–±—ã–ª—å': details.get('–ø—Ä–∏–±—ã–ª—å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–∞—è', 0),
                
                # –†–∞—Å—á–µ—Ç–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
                '–õ–∏—á–Ω—ã–π_–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å': score,
                '–î–æ–ª—è': rating,
                '–ö–æ—Ç–µ–ª_–æ—Ç–¥–µ–ª–∞': department_boiler,
                '–î–æ–ª_–ø—Ä–µ–º': boiler_share,
                '–ó–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤': –∑–∞—Ä–ø–ª–∞—Ç–∞_–ø—Ä–µ–¥–≤,
                '–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–ø—Ç–æ–º': –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–ø—Ç–æ–º,
                '–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–µ–π': –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_—Ä–æ–∑–Ω_–ø—Ä–æ—á–µ–π,
                '–û–∫–ª–∞–¥_–∏–Ω–¥': –æ–∫–ª–∞–¥_–∏–Ω–¥,
                '–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–∫–ª–∞–¥–æ–º': –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–æ–∫–ª–∞–¥–æ–º,
                '–ú–∏–Ω–∏–º–∞–ª–∫–∞_–∏–Ω–¥': –º–∏–Ω–∏–º–∞–ª–∫–∞_–∏–Ω–¥,
                '–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π': –∑–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π,
                
                # –ì–∞—Ä–∞–Ω—Ç–∏–∏ (–ø–æ–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã–µ)
                '–ì–∞—Ä–∞–Ω—Ç–∏—è_1': –≥–∞—Ä–∞–Ω—Ç–∏—è_1,
                '–ì–∞—Ä–∞–Ω—Ç–∏—è_2': –≥–∞—Ä–∞–Ω—Ç–∏—è_2,
                '–ì–∞—Ä–∞–Ω—Ç–∏—è_3': –≥–∞—Ä–∞–Ω—Ç–∏—è_3,
                '–ì–∞—Ä–∞–Ω—Ç–∏—è_4': –≥–∞—Ä–∞–Ω—Ç–∏—è_4,
                '–ì–∞—Ä–∞–Ω—Ç–∏—è_5': –≥–∞—Ä–∞–Ω—Ç–∏—è_5,
                '–ì–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è': –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è,
                '–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è': –ø—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è,
                '–†–∞–∑–Ω–∏—Ü–∞_–ø–æ_—á–∞—Å–∞–º': —Ä–∞–∑–Ω–∏—Ü–∞_–ø–æ_—á–∞—Å–∞–º,
                
                # –ò—Ç–æ–≥–æ–≤–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞
                '–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ': –∏—Ç–æ–≥–æ–≤–∞—è_–∑–∞—Ä–ø–ª–∞—Ç–∞,
                '–ú–µ—Å—Ç–æ': –º–µ—Å—Ç–æ,
                
                # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (–¥–ª—è –æ—Ç—á–µ—Ç–∞)
                '–ö–æ—ç—Ñ_–æ–±—ã—á–Ω—ã—Ö': f"{float(emp.get('–ö–æ—ç—Ñ_–æ–±—ã—á–Ω—ã—Ö', 0.0)):.1f} %",
                '–ö–æ—ç—Ñ_–±–æ–Ω—É—Å–Ω—ã—Ö': f"{float(emp.get('–ö–æ—ç—Ñ_–±–æ–Ω—É—Å–Ω—ã—Ö', 0.0)):.1f} %",
                '–ö–æ—ç—Ñ_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤': f"{float(emp.get('–ö–æ—ç—Ñ_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤', 0.0)):.1f} %",
                '–ö–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö': f"{float(emp.get('–ö–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö', 0.0)):.1f} %",

                # –ö–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ (–∏–∑ –î–∞–Ω–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂)
                '–†–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ': –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏.get('items_count', 0),
                '–†–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ': –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏.get('bonus_items_count', 0),
                '–†–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ': –ø—Ä–æ–¥–∞–∂–∏_—á–µ–∫–∏.get('non_liquid_items_count', 0),
                '–û–ø—Ç_–∫–æ–ª–≤–æ': –ø—Ä–æ–¥–∞–∂–∏_–æ–ø—Ç.get('items_count', 0),
                '–ü—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ': –ø—Ä–æ–¥–∞–∂–∏_–ø—Ä–æ—á–∞—è.get('items_count', 0),

                # --- –ó–ê–ö–ê–ó–ù–´–ï –¢–û–í–ê–†–´ - –í–°–ï –í–ù–£–¢–†–ò –°–õ–û–í–ê–†–Ø! ---
                '–ó–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ': ordered_data.get('items', 0),
                '–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ': unordered_data.get('items', 0),
                '–ó–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å': ordered_data.get('profit', 0),
                '–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å': unordered_data.get('profit', 0),
                '–ó–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂–∏': ordered_data.get('revenue', 0),
                '–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂–∏': unordered_data.get('revenue', 0),
            }
            
            results.append(result)
            
        
        # ===== –≠–¢–ê–ü 10: –ì–ê–†–ê–ù–¢–ò–ò –¢–û–ü-3 =====
         # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ —É –æ—Ç–¥–µ–ª–∞
        total_guarantees = sum(results[0].get(f'–ì–∞—Ä–∞–Ω—Ç–∏—è_{i}', 0) for i in range(1, 6))
        if total_guarantees > 0 and len(results) >= 1:
            sorted_results = sorted(results, key=lambda x: x['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'], reverse=True)
            
            for i in range(min(5, len(sorted_results))):
                fio_to_find = sorted_results[i]['–§–ò–û']
                original_idx = None
                
                # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Å–ø–∏—Å–∫–µ
                for idx, result in enumerate(results):
                    if result['–§–ò–û'] == fio_to_find:
                        original_idx = idx
                        break
                
                if original_idx is None:
                    continue
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—é –¥–ª—è –º–µ—Å—Ç–∞
                if i == 0:
                    –≥–∞—Ä–∞–Ω—Ç–∏—è = results[original_idx]['–ì–∞—Ä–∞–Ω—Ç–∏—è_1']
                elif i == 1:
                    –≥–∞—Ä–∞–Ω—Ç–∏—è = results[original_idx]['–ì–∞—Ä–∞–Ω—Ç–∏—è_2']
                elif i == 2:
                    –≥–∞—Ä–∞–Ω—Ç–∏—è = results[original_idx]['–ì–∞—Ä–∞–Ω—Ç–∏—è_3']
                elif i == 3:
                    –≥–∞—Ä–∞–Ω—Ç–∏—è = results[original_idx]['–ì–∞—Ä–∞–Ω—Ç–∏—è_4']
                elif i == 4:
                    –≥–∞—Ä–∞–Ω—Ç–∏—è = results[original_idx]['–ì–∞—Ä–∞–Ω—Ç–∏—è_5']
                
                if –≥–∞—Ä–∞–Ω—Ç–∏—è > 0:
                    hours = results[original_idx]['–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ_—á–∞—Å–æ–≤']
                    norm = results[original_idx]['–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤']
                    
                    # –ö–û–†–†–ï–ö–¢–ò–†–û–í–ö–ê –ì–ê–†–ê–ù–¢–ò–ò –ü–û –ß–ê–°–ê–ú
                    if norm_hours > 0:
                        if hours >= norm_hours:  # –û—Ç—Ä–∞–±–æ—Ç–∞–ª –Ω–æ—Ä–º—É –∏–ª–∏ –±–æ–ª—å—à–µ ‚Üí –ø–æ–ª–Ω–∞—è –≥–∞—Ä–∞–Ω—Ç–∏—è
                            –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä = –≥–∞—Ä–∞–Ω—Ç–∏—è
                        else:  # –û—Ç—Ä–∞–±–æ—Ç–∞–ª –º–µ–Ω—å—à–µ –Ω–æ—Ä–º—ã ‚Üí –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
                            –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä = max(0, –≥–∞—Ä–∞–Ω—Ç–∏—è * (hours / norm_hours))
                    else:
                        –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä = max(0, –≥–∞—Ä–∞–Ω—Ç–∏—è)
                    
                    # –ü—Ä–∏–º–µ–Ω—è–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—é, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞ –º–µ–Ω—å—à–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏
                    —Ç–µ–∫—É—â–∞—è_–∑–∞—Ä–ø–ª–∞—Ç–∞ = results[original_idx]['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ']
                    if —Ç–µ–∫—É—â–∞—è_–∑–∞—Ä–ø–ª–∞—Ç–∞ < –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä:
                        results[original_idx]['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'] = –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä
                        results[original_idx]['–ì–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è'] = –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä
                        results[original_idx]['–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è'] = –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä
                        results[original_idx]['–ú–µ—Å—Ç–æ'] = i + 1
                        
                        # –≠–¢–ê–ü 11: –†–∞–∑–Ω–∏—Ü–∞ –ø–æ —á–∞—Å–∞–º
                        results[original_idx]['–†–∞–∑–Ω–∏—Ü–∞_–ø–æ_—á–∞—Å–∞–º'] = –≥–∞—Ä–∞–Ω—Ç–∏—è - –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä
                        
                        print(f"  üèÜ {results[original_idx]['–§–ò–û']}: {i+1} –º–µ—Å—Ç–æ")
                        print(f"     –ì–∞—Ä–∞–Ω—Ç–∏—è: {–≥–∞—Ä–∞–Ω—Ç–∏—è:,.0f} —Ä—É–±.")
                        print(f"     –ì–∞—Ä–∞–Ω—Ç–∏—è (—Å–∫–æ—Ä—Ä): {–≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä:,.0f} —Ä—É–±.")
                        print(f"     –ë—ã–ª–æ: {—Ç–µ–∫—É—â–∞—è_–∑–∞—Ä–ø–ª–∞—Ç–∞:,.0f} —Ä—É–±. ‚Üí –°—Ç–∞–ª–æ: {–≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä:,.0f} —Ä—É–±.")
                        print(f"     –†–∞–∑–Ω–∏—Ü–∞ –ø–æ —á–∞—Å–∞–º: {–≥–∞—Ä–∞–Ω—Ç–∏—è - –≥–∞—Ä–∞–Ω—Ç–∏—è_—Å–∫–æ—Ä—Ä:,.0f} —Ä—É–±.")

        # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞ –¥–ª—è –æ—Ç–¥–µ–ª–∞
        if dept_name == "–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫–∞ —Å–∞–Ω—Ñ–∞—è–Ω—Å –ë–î1":
            print(f"\nüìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–°–ß–ï–¢–ê –î–õ–Ø –û–¢–î–ï–õ–ê: {dept_name}")
            print("-"*80)
            print(f"{'–§–ò–û':30} | {'–î–æ–ª—è':>6} | {'–î–æ–ª_–ø—Ä–µ–º':>10} | {'–ì–∞—Ä–∞–Ω—Ç–∏–∏':>9} | {'–ò—Ç–æ–≥':>10} | {'–ú–µ—Å—Ç–æ':>5}")
            print("-"*80)
            for result in results:
                print(f"{result['–§–ò–û'][:30]:30} | {result['–î–æ–ª—è']*100:6.1f}% | "
                      f"{result['–î–æ–ª_–ø—Ä–µ–º']:10,.0f} | "
                      f"{result['–ì–∞—Ä–∞–Ω—Ç–∏—è_1']}/{result['–ì–∞—Ä–∞–Ω—Ç–∏—è_2']}/{result['–ì–∞—Ä–∞–Ω—Ç–∏—è_3']:7} | "
                      f"{result['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ']:10,.0f} | {result.get('–ú–µ—Å—Ç–æ', 0):5}")
            print("="*80)
        return results

    
    
    def _add_places(self, results_df):
        df = results_df.copy()
        df['–ú–µ—Å—Ç–æ'] = 0  
        
        for dept in df['–û—Ç–¥–µ–ª'].unique():
            dept_mask = df['–û—Ç–¥–µ–ª'] == dept
            dept_indices = df[dept_mask].index
            
            sorted_indices = df.loc[dept_indices].sort_values('–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π', ascending=False).index
            
            for place, idx in enumerate(sorted_indices, 1):
                df.at[idx, '–ú–µ—Å—Ç–æ'] = place  
        
        return df
    
    def print_results(self, calculations):
        """
        –í—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞
        """
        if not calculations:
            return
        
        results_df = calculations['by_employee']
        
        print("\n" + "="*80)
        print("–†–ï–ó–£–õ–¨–¢–ê–¢–´ –†–ê–°–ß–ï–¢–ê")
        print("="*80)
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        departments = sorted(results_df['–û—Ç–¥–µ–ª'].unique())
        
        for dept in departments:
            dept_df = results_df[results_df['–û—Ç–¥–µ–ª'] == dept]
            dept_boiler = dept_df['–ö–æ—Ç–µ–ª_–æ—Ç–¥–µ–ª–∞'].iloc[0]
            
            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–∞—Ä–∞–Ω—Ç–∏—è—Ö
            guarantee_info = ""
            guarantee_1 = dept_df['–ì–∞—Ä–∞–Ω—Ç–∏—è_1'].iloc[0]
            guarantee_2 = dept_df['–ì–∞—Ä–∞–Ω—Ç–∏—è_2'].iloc[0]
            guarantee_3 = dept_df['–ì–∞—Ä–∞–Ω—Ç–∏—è_3'].iloc[0]
            
            if guarantee_1 > 0:
                guarantee_info = f" (–≥–∞—Ä–∞–Ω—Ç–∏–∏: {guarantee_1:,.0f}/{guarantee_2:,.0f}/{guarantee_3:,.0f})"
            
            print(f"\nüìÅ {dept}{guarantee_info}")
            print(f"–ö–æ—Ç–µ–ª: {dept_boiler:,.0f} —Ä—É–±.")
            print("-" * 100)
            print(f"{'–§–ò–û':25} | {'–ß–∞—Å—ã':5} | {'–î–æ–ª—è':7} | {'–î–æ–ª—è –∫–æ—Ç–ª–∞':10} | {'–û–∫–ª–∞–¥':10} | {'–ò—Ç–æ–≥–æ':10} | {'–ú–µ—Å—Ç–æ':5}")
            print("-" * 100)
            
            for _, row in dept_df.iterrows():
                # –û—Ç–º–µ—á–∞–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—é –∑–Ω–∞–∫–æ–º ‚≠ê
                guarantee_mark = "‚≠ê" if row['–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è'] > 0 else " "
                
                print(f"{row['–§–ò–û'][:25]:25} | "
                      f"{row['–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ_—á–∞—Å–æ–≤']:5.0f} | "
                      f"{row['–î–æ–ª—è']*100:7.1f}% | "
                      f"{row['–î–æ–ª_–ø—Ä–µ–º']:10,.0f} | "
                      f"{row['–û–∫–ª–∞–¥_–∏–Ω–¥']:10,.0f} | "
                      f"{row['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ']:10,.0f} | "
                      f"{row.get('–ú–µ—Å—Ç–æ', 0):4}{guarantee_mark}")
        
        print("\n" + "="*80)
        print("–ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê")
        print("="*80)
        
        total_salary = results_df['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'].sum()
        avg_salary = results_df['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'].mean()
        median_salary = results_df['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ'].median()
        total_hours = results_df['–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ_—á–∞—Å–æ–≤'].sum()
        total_sales = results_df['–í—ã—Ä—É—á–∫–∞_–≤—Å–µ–≥–æ'].sum()
        
        print(f"–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {len(results_df)}")
        print(f"–§–æ–Ω–¥ –∑–∞—Ä–ø–ª–∞—Ç—ã: {total_salary:,.0f} —Ä—É–±.")
        print(f"–°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞: {avg_salary:,.0f} —Ä—É–±.")
        print(f"–ú–µ–¥–∏–∞–Ω–Ω–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞: {median_salary:,.0f} —Ä—É–±.")
        print(f"–í—Å–µ–≥–æ —á–∞—Å–æ–≤: {total_hours:,.0f}")
        print(f"–í—Å–µ–≥–æ –ø—Ä–æ–¥–∞–∂: {total_sales:,.0f} —Ä—É–±.")
        
        # –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å –≥–∞—Ä–∞–Ω—Ç–∏—è–º–∏
        with_guarantees = results_df[results_df['–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è'] > 0]
        if not with_guarantees.empty:
            print(f"\nüèÜ –°–û–¢–†–£–î–ù–ò–ö–ò –° –ì–ê–†–ê–ù–¢–ò–Ø–ú–ò ({len(with_guarantees)}):")
            for _, row in with_guarantees.iterrows():
                print(f"  {row['–§–ò–û']} - {row['–û—Ç–¥–µ–ª']} ({row['–ú–µ—Å—Ç–æ']} –º–µ—Å—Ç–æ): "
                      f"{row['–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ']:,.0f} —Ä—É–±. (–≥–∞—Ä–∞–Ω—Ç–∏—è: {row['–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è']:,.0f})")
