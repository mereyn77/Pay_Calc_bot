"""
–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ —É–ø—Ä–∞–≤–ª—è—é—â–µ–≥–æ —Å —Ç–æ—á–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
Glass-morphism, –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
"""

import pandas as pd
import json
import os
from datetime import datetime

class ManagerDashboardPro:
    """
    –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ —Å —Ç–æ—á–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º –∏–∑ –¢–ó
    Glass-morphism, –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã, –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ
    """
    
    def __init__(self, data_manager):
        self.dm = data_manager
        self.df = None
        self.passwords = {
            "bd1": "BD1_PASS",
            "bd3": "BD3_PASS", 
            "bd4": "BD4_PASS",
            "ALL": "MASTER_KEY"
        }
        self.app_title = "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
        self.reports_dir = "–æ—Ç—á—ë—Ç–Ω—ã–µ_–ø–∞–ø–∫–∏/–¥–∞—à–±–æ—Ä–¥—ã_–ø—Ä–æ"
        os.makedirs(self.reports_dir, exist_ok=True)
    
    def load_from_calculations(self):
        """
        –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–∞—à–±–æ—Ä–¥–∞
        —Å —É—á–µ—Ç–æ–º –í–°–ï–• –ø–æ–ª–µ–π –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        """
        if not hasattr(self.dm, 'calculations') or 'by_employee' not in self.dm.calculations:
            raise ValueError("–ù–µ—Ç —Ä–∞—Å—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã.")
        
        df_calc = self.dm.calculations['by_employee'].copy()
        
        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–∏–ª–∏–∞–ª—ã
        if '–§–∏–ª–∏–∞–ª' in df_calc.columns:
            df_calc['–§–∏–ª–∏–∞–ª'] = df_calc['–§–∏–ª–∏–∞–ª'].astype(str).str.replace(r'\s+', '', regex=True)
            df_calc['–§–∏–ª–∏–∞–ª'] = df_calc['–§–∏–ª–∏–∞–ª'].str.upper()
        
        print(f"üîç [–î–∞—à–±–æ—Ä–¥ Pro] –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df_calc)} –∑–∞–ø–∏—Å–µ–π")
        
        dashboard_data = []


        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–ª–æ–Ω–∫–∏ –î–æ–ª_–ø—Ä–µ–º
        print(f"\n=== –ü–†–û–í–ï–†–ö–ê –í load_from_calculations ===")
        print(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ df_calc: {list(df_calc.columns)}")
        print(f"–ï—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞ '–î–æ–ª_–ø—Ä–µ–º': {'–î–æ–ª_–ø—Ä–µ–º' in df_calc.columns}")
        if '–î–æ–ª_–ø—Ä–µ–º' in df_calc.columns:
            print(f"–ü—Ä–∏–º–µ—Ä—ã –∑–Ω–∞—á–µ–Ω–∏–π –î–æ–ª_–ø—Ä–µ–º:")
            print(df_calc[['–§–ò–û', '–û—Ç–¥–µ–ª', '–î–æ–ª_–ø—Ä–µ–º']].head(5))
        

        
        for idx, row in df_calc.iterrows():
            # –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            —Ñ–∏–ª–∏–∞–ª = str(row.get('–§–∏–ª–∏–∞–ª', '')).replace(' ', '').replace('–ë–î', 'bd').lower()
            if not —Ñ–∏–ª–∏–∞–ª or —Ñ–∏–ª–∏–∞–ª == 'nan':
                —Ñ–∏–ª–∏–∞–ª = 'bd1'
            
            —Ñ–∏–æ = str(row.get('–§–ò–û', f'–°–æ—Ç—Ä—É–¥–Ω–∏–∫ {idx}')).strip()
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤
            —Ñ–∏–æ_–Ω–æ—Ä–º = ' '.join(—Ñ–∏–æ.split()).upper()
            –ø—Ä–æ–¥–∞–∂–∏_–¥–∞–Ω–Ω—ã–µ = None
            
            # –ò—â–µ–º –ø—Ä–æ–¥–∞–∂–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if hasattr(self.dm, 'sales_data') and self.dm.sales_data:
                for seller_name, sales_info in self.dm.sales_data.items():
                    seller_norm = ' '.join(str(seller_name).split()).upper()
                    if seller_norm == —Ñ–∏–æ_–Ω–æ—Ä–º:
                        –ø—Ä–æ–¥–∞–∂–∏_–¥–∞–Ω–Ω—ã–µ = sales_info
                        break
            
            # –î–∞–Ω–Ω—ã–µ –æ –∑–∞–∫–∞–∑–Ω—ã—Ö/–Ω–µ–∑–∞–∫–∞–∑–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö
            # –î–∞–Ω–Ω—ã–µ –æ –∑–∞–∫–∞–∑–Ω—ã—Ö/–Ω–µ–∑–∞–∫–∞–∑–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö (–∏–∑ —Ä–∞—Å—á–µ—Ç–æ–≤)
            –∑–∞–∫–∞–∑–Ω—ã–µ_–¥–∞–Ω–Ω—ã–µ = {
                'unordered': {
                    'items': row.get('–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', 0),
                    'profit': 0  # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—è –ø—Ä–∏–±—ã–ª–∏
                },
                'ordered': {
                    'items': row.get('–ó–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', 0),
                    'profit': 0  # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—è –ø—Ä–∏–±—ã–ª–∏
                }
            }
            
            # –ë–µ—Ä–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑ calculations (–¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ salary_calculator.py)
            —Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ = row.get('–†–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ', 0)
            —Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ = row.get('–†–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ', 0)
            —Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ = row.get('–†–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ', 0)
            –æ–ø—Ç_–∫–æ–ª–≤–æ = row.get('–û–ø—Ç_–∫–æ–ª–≤–æ', 0)
            –ø—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ = row.get('–ü—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ', 0)
            
            if –ø—Ä–æ–¥–∞–∂–∏_–¥–∞–Ω–Ω—ã–µ:
                # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ sales_by_type
                sales_by_type = –ø—Ä–æ–¥–∞–∂–∏_–¥–∞–Ω–Ω—ã–µ.get('sales_by_type', {})
                
                # –†–æ–∑–Ω–∏—á–Ω–∞—è (–ø–æ —á–µ–∫–∞–º)
                —Ä–æ–∑–Ω–∏—á–Ω–∞—è_—á–µ–∫–∏ = sales_by_type.get('–†–æ–∑–Ω–∏—á–Ω–∞—è (–ø–æ —á–µ–∫–∞–º)', {})
                —Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ = —Ä–æ–∑–Ω–∏—á–Ω–∞—è_—á–µ–∫–∏.get('items_count', 0)
                —Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ = —Ä–æ–∑–Ω–∏—á–Ω–∞—è_—á–µ–∫–∏.get('bonus_items_count', 0)
                —Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ = —Ä–æ–∑–Ω–∏—á–Ω–∞—è_—á–µ–∫–∏.get('non_liquid_items_count', 0)
                
                # –û–ø—Ç–æ–≤–∞—è
                –æ–ø—Ç–æ–≤–∞—è = sales_by_type.get('–û–ø—Ç–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞', {})
                –æ–ø—Ç_–∫–æ–ª–≤–æ = –æ–ø—Ç–æ–≤–∞—è.get('items_count', 0)
                
                # –†–æ–∑–Ω–∏—á–Ω–∞—è –ø—Ä–æ—á–∞—è
                —Ä–æ–∑–Ω–∏—á–Ω–∞—è_–ø—Ä–æ—á–∞—è = sales_by_type.get('–†–æ–∑–Ω–∏—á–Ω–∞—è (–ø—Ä–æ—á–∞—è)', {})
                –ø—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ = —Ä–æ–∑–Ω–∏—á–Ω–∞—è_–ø—Ä–æ—á–∞—è.get('items_count', 0)
            –æ—Ç–¥–µ–ª = str(row.get('–û—Ç–¥–µ–ª', '–ù–µ —É–∫–∞–∑–∞–Ω'))
            
            # –ß–∞—Å—ã –∏ –Ω–æ—Ä–º—ã
            –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ = float(row.get('–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ_—á–∞—Å–æ–≤', 0))
            –Ω–æ—Ä–º–∞ = float(row.get('–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤', 168))

            # –ü—Ä–æ–¥–∞–∂–∏ –∏ –ø—Ä–µ–º–∏–∏ (–∏–∑ –Ω–∞—à–µ–π 12-—ç—Ç–∞–ø–Ω–æ–π —Å—Ö–µ–º—ã)
            –¥–æ–ª_–ø—Ä–µ–º = row.get('–î–æ–ª_–ø—Ä–µ–º', 0)  # ‚Üê –í–ú–ï–°–¢–û –ø—Ä–µ–º–∏—è_—Ä–æ–∑–Ω–∏—Ü–∞

            # –†–∞—Å—á–µ—Ç –¥–æ–ª–µ–π –≤–Ω—É—Ç—Ä–∏ —Ä–æ–∑–Ω–∏—Ü—ã
            –æ–±—â–∞—è_—Ä–æ–∑–Ω–∏—Ü–∞ = (row.get('–û–±—ã—á–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏', 0) + 
                             row.get('–ë–æ–Ω—É—Å–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏', 0) + 
                             row.get('–ù–µ–ª–∏–∫–≤–∏–¥–Ω–∞—è_–≤—ã—Ä—É—á–∫–∞_—á–µ–∫–∏', 0))

            if –æ–±—â–∞—è_—Ä–æ–∑–Ω–∏—Ü–∞ > 0:
                –¥–æ–ª—è_–æ–±—ã—á–Ω = row.get('–û–±—ã—á–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏', 0) / –æ–±—â–∞—è_—Ä–æ–∑–Ω–∏—Ü–∞
                –¥–æ–ª—è_–±–æ–Ω—É—Å = row.get('–ë–æ–Ω—É—Å–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏', 0) / –æ–±—â–∞—è_—Ä–æ–∑–Ω–∏—Ü–∞
                –¥–æ–ª—è_–Ω–µ–ª–∏–∫ = row.get('–ù–µ–ª–∏–∫–≤–∏–¥–Ω–∞—è_–≤—ã—Ä—É—á–∫–∞_—á–µ–∫–∏', 0) / –æ–±—â–∞—è_—Ä–æ–∑–Ω–∏—Ü–∞
            else:
                –¥–æ–ª—è_–æ–±—ã—á–Ω = –¥–æ–ª—è_–±–æ–Ω—É—Å = –¥–æ–ª—è_–Ω–µ–ª–∏–∫ = 0

            # –î–µ–Ω–µ–∂–Ω—ã–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –∏–∑ –î–æ–ª.–ø—Ä–µ–º
            –æ–±—ã—á–Ω—ã–µ = –¥–æ–ª_–ø—Ä–µ–º * –¥–æ–ª—è_–æ–±—ã—á–Ω
            –±–æ–Ω—É—Å–Ω—ã–µ = –¥–æ–ª_–ø—Ä–µ–º * –¥–æ–ª—è_–±–æ–Ω—É—Å
            –Ω–µ–ª–∏–∫–≤–∏–¥ = –¥–æ–ª_–ø—Ä–µ–º * –¥–æ–ª—è_–Ω–µ–ª–∏–∫

            # –û–ø—Ç–æ–≤—ã–µ –ø—Ä–µ–º–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å (–Ω–µ –º–µ–Ω—è–µ–º)
            –∫–æ—ç—Ñ_–æ–ø—Ç_—Å—Ç—Ä–æ–∫–∞ = str(row.get('–ö–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö', 0)).replace(',', '.').replace(' %', '').strip()
            –∫–æ—ç—Ñ_–æ–ø—Ç = float(–∫–æ—ç—Ñ_–æ–ø—Ç_—Å—Ç—Ä–æ–∫–∞) if –∫–æ—ç—Ñ_–æ–ø—Ç_—Å—Ç—Ä–æ–∫–∞ and –∫–æ—ç—Ñ_–æ–ø—Ç_—Å—Ç—Ä–æ–∫–∞ != 'nan' else 0
            –ø—Ä–µ–º–∏—è_–æ–ø—Ç = row.get('–û–ø—Ç–æ–≤–∞—è_–ø—Ä–∏–±—ã–ª—å', 0) * (–∫–æ—ç—Ñ_–æ–ø—Ç / 100)
            –ø—Ä–µ–º–∏—è_–ø—Ä–æ—á–∞—è = row.get('–†–æ–∑–Ω_–ø—Ä–æ—á–∞—è_–ø—Ä–∏–±—ã–ª—å', 0) * (–∫–æ—ç—Ñ_–æ–ø—Ç / 100)

            # –û—Ç–ª–∞–¥–∫–∞
            print(f"DEBUG: –§–ò–û={—Ñ–∏–æ[:20]}, –î–æ–ª.–ø—Ä–µ–º={–¥–æ–ª_–ø—Ä–µ–º:.0f}")
            print(f"       –û–±—ã—á–Ω—ã–µ: {–¥–æ–ª—è_–æ–±—ã—á–Ω:.1%} √ó {–¥–æ–ª_–ø—Ä–µ–º:.0f} = {–æ–±—ã—á–Ω—ã–µ:.0f}")
            print(f"       –ë–æ–Ω—É—Å–Ω—ã–µ: {–¥–æ–ª—è_–±–æ–Ω—É—Å:.1%} √ó {–¥–æ–ª_–ø—Ä–µ–º:.0f} = {–±–æ–Ω—É—Å–Ω—ã–µ:.0f}")
            print(f"       –ù–µ–ª–∏–∫–≤–∏–¥—ã: {–¥–æ–ª—è_–Ω–µ–ª–∏–∫:.1%} √ó {–¥–æ–ª_–ø—Ä–µ–º:.0f} = {–Ω–µ–ª–∏–∫–≤–∏–¥:.0f}")         
            # –°—Ö–µ–º–∞ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏
            —Å—Ö–µ–º–∞ = row.get('–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π', 0)
            –≥–∞—Ä–∞–Ω—Ç–∏–∏ = row.get('–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è', 0)
            —Ä–∞–∑–Ω–∏—Ü–∞ = row.get('–†–∞–∑–Ω–∏—Ü–∞_–ø–æ_—á–∞—Å–∞–º', 0)
            –∏—Ç–æ–≥–æ = row.get('–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ', 0)
            
            # –î–æ–ª—è (–±—ã–≤—à–∏–π –†–µ–π—Ç–∏–Ω–≥)
            —Ä–µ–π—Ç–∏–Ω–≥ = float(row.get('–î–æ–ª—è', 0) * 100)
            
            # –î–Ω–∏ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∏ - –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞)
            –æ—Ç–ø—É—Å–∫ = 0
            –≤—ã—Ö–æ–¥–Ω—ã–µ = 0
            –±–æ–ª—å–Ω–∏—á–Ω—ã–µ = 0

            # –ò—â–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ integrated_data
            if hasattr(self.dm, 'integrated_data') and self.dm.integrated_data is not None:
                mask = self.dm.integrated_data['–§–ò–û_–Ω–æ—Ä–º'] == —Ñ–∏–æ_–Ω–æ—Ä–º
                if mask.any():
                    emp_row = self.dm.integrated_data[mask].iloc[0]
                    –æ—Ç–ø—É—Å–∫ = emp_row.get('–û—Ç–ø—É—Å–∫_–¥–Ω–∏', 0)
                    –≤—ã—Ö–æ–¥–Ω—ã–µ = emp_row.get('–í—ã—Ö–æ–¥–Ω—ã–µ_–¥–Ω–∏', 0)
                    –±–æ–ª—å–Ω–∏—á–Ω—ã–µ = emp_row.get('–ë–æ–ª—å–Ω–∏—á–Ω—ã–µ_–¥–Ω–∏', 0)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–ª–∏–∞–ª –ø–æ –¥–∞–Ω–Ω—ã–º
            if '–ë–î1' in —Ñ–∏–ª–∏–∞–ª.upper() or 'BD1' in —Ñ–∏–ª–∏–∞–ª.upper():
                branch = 'bd1'
            elif '–ë–î3' in —Ñ–∏–ª–∏–∞–ª.upper() or 'BD3' in —Ñ–∏–ª–∏–∞–ª.upper():
                branch = 'bd3'
            elif '–ë–î4' in —Ñ–∏–ª–∏–∞–ª.upper() or 'BD4' in —Ñ–∏–ª–∏–∞–ª.upper():
                branch = 'bd4'
            else:
                branch = 'bd1'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
            
            record = {
                'branch': branch,
                'fio': —Ñ–∏–æ,
                'dept': –æ—Ç–¥–µ–ª,
                'vacation': –æ—Ç–ø—É—Å–∫,
                'weekend': –≤—ã—Ö–æ–¥–Ω—ã–µ,
                'sick': –±–æ–ª—å–Ω–∏—á–Ω—ã–µ,
                'no_show': emp_row.get('–ù–µ–≤—ã—Ö–æ–¥_–¥–Ω–∏', 0) if 'emp_row' in locals() else 0,
                'worked': –æ—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ,
                'norm': –Ω–æ—Ä–º–∞,
                'rating': —Ä–µ–π—Ç–∏–Ω–≥,
                'dol_prem': row.get('–î–æ–ª_–ø—Ä–µ–º', 0),
                'regular': –æ–±—ã—á–Ω—ã–µ,
                'bonus': –±–æ–Ω—É—Å–Ω—ã–µ,
                'nonliquid': –Ω–µ–ª–∏–∫–≤–∏–¥,
                'premWholesale': –ø—Ä–µ–º–∏—è_–æ–ø—Ç,
                'premOther': –ø—Ä–µ–º–∏—è_–ø—Ä–æ—á–∞—è,
                'scheme': —Å—Ö–µ–º–∞,
                'guarantee': –≥–∞—Ä–∞–Ω—Ç–∏–∏,
                'diff': —Ä–∞–∑–Ω–∏—Ü–∞,
                'total': –∏—Ç–æ–≥–æ,
                # –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤
                '—Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ': —Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ,
                '—Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ': —Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ,
                '—Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ': —Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ,
                '–æ–ø—Ç_–∫–æ–ª–≤–æ': –æ–ø—Ç_–∫–æ–ª–≤–æ,
                '–ø—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ': –ø—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ,
                '—Ä–æ–∑–Ω–∏—Ü–∞_–æ–±—â–∞—è_–∫–æ–ª–≤–æ': —Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ,
                '–æ–±—ã—á–Ω—ã–µ_–∫–æ–ª–≤–æ': —Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ - —Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ - —Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ,
                # –î–∞–Ω–Ω—ã–µ –ø–æ –∑–∞–∫–∞–∑–Ω—ã–º —Ç–æ–≤–∞—Ä–∞–º
                '–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ': row.get('–ó–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', 0),
                '–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ': row.get('–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', 0),
                '–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å': row.get('–ó–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å', 0),
                '–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å': row.get('–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å', 0),
                '–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂–∏': row.get('–ó–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂–∏', 0),
                '–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂–∏': row.get('–ù–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–æ–¥–∞–∂–∏', 0),
                }
            
            dashboard_data.append(record)
        
        self.df = pd.DataFrame(dashboard_data)
        print(f"‚úÖ [–î–∞—à–±–æ—Ä–¥ Pro] –°–æ–∑–¥–∞–Ω–æ {len(self.df)} –∑–∞–ø–∏—Å–µ–π")
        print("\n=== –ü–†–û–í–ï–†–ö–ê –ü–ï–†–ï–î–ê–ß–ò dol_prem ===")
        print(f"–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(self.df)}")
        if not self.df.empty:
            print(f"–ö–æ–ª–æ–Ω–∫–∏: {list(self.df.columns)}")
            print(f"–ü–µ—Ä–≤—ã–µ 3 –∑–∞–ø–∏—Å–∏ dol_prem:")
            for i, row in self.df.head(3).iterrows():
                print(f"  {row['fio']}: dol_prem={row['dol_prem']} (—Ç–∏–ø: {type(row['dol_prem'])})")
        print("\n=== –ü–†–û–í–ï–†–ö–ê –ó–ê–ö–ê–ó–ù–´–• –¢–û–í–ê–†–û–í –í self.df ===")
        if not self.df.empty:
            print(f"–ö–æ–ª–æ–Ω–∫–∞ '–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ' –≤ DataFrame: {'–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ' in self.df.columns}")
            if '–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ' in self.df.columns:
                print(f"–ü–µ—Ä–≤—ã–µ 3 –∑–Ω–∞—á–µ–Ω–∏—è:")
                for i, row in self.df.head(3).iterrows():
                    print(f"  {row['fio']}: –∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ={row.get('–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', '–ù–ï–¢')}")
        return self.df
    
    def generate(self, output_file=None):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç HTML –¥–∞—à–±–æ—Ä–¥ —Å –¢–û–ß–ù–´–ú –¥–∏–∑–∞–π–Ω–æ–º –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
        """
        if self.df is None:
            self.load_from_calculations()
        
        if output_file is None:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M")
            period = self.dm.report_period.replace(" ", "_") if hasattr(self.dm, 'report_period') else "–î–µ–∫–∞–±—Ä—å_2025"
            output_file = f"–¥–∞—à–±–æ—Ä–¥_–ø—Ä–æ_{period}_{timestamp}.html"
        
        filepath = os.path.join(self.reports_dir, output_file)
        print(f"üîç [–î–∞—à–±–æ—Ä–¥] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ —Ñ–∞–π–ª: {filepath}")
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è JS
        data_by_branch = {
            'bd1': [],
            'bd3': [],
            'bd4': []
        }
        
        # –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º
        for _, row in self.df.iterrows():
            branch = row.get('branch', 'bd1')
            
            if branch in data_by_branch:
                data_by_branch[branch].append({
                    'fio': row['fio'],
                    'dept': row['dept'],
                    'vacation': row['vacation'],
                    'weekend': row['weekend'],
                    'sick': row['sick'],
                    'worked': row['worked'],
                    'norm': row['norm'],
                    'rating': row['rating'],
                    'dol_prem': row.get('dol_prem', 0),
                    'regular': row['regular'],
                    'bonus': row['bonus'],
                    'nonliquid': row['nonliquid'],
                    'premWholesale': row['premWholesale'],
                    'premOther': row['premOther'],
                    'scheme': row['scheme'],
                    'guarantee': row['guarantee'],
                    'diff': row['diff'],
                    'total': row['total'],
                    '—Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ': row['—Ä–æ–∑–Ω–∏—Ü–∞_–∫–æ–ª–≤–æ'],
                    '—Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ': row['—Ä–æ–∑–Ω–∏—Ü–∞_–±–æ–Ω—É—Å_–∫–æ–ª–≤–æ'],
                    '—Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ': row['—Ä–æ–∑–Ω–∏—Ü–∞_–Ω–µ–ª–∏–∫–≤–∏–¥_–∫–æ–ª–≤–æ'],
                    '–æ–ø—Ç_–∫–æ–ª–≤–æ': row['–æ–ø—Ç_–∫–æ–ª–≤–æ'],
                    '–ø—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ': row['–ø—Ä–æ—á–∞—è_–∫–æ–ª–≤–æ'],
                    '—Ä–æ–∑–Ω–∏—Ü–∞_–æ–±—â–∞—è_–∫–æ–ª–≤–æ': row['—Ä–æ–∑–Ω–∏—Ü–∞_–æ–±—â–∞—è_–∫–æ–ª–≤–æ'],
                    '–æ–±—ã—á–Ω—ã–µ_–∫–æ–ª–≤–æ': row['–æ–±—ã—á–Ω—ã–µ_–∫–æ–ª–≤–æ'],
                    '–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ': row.get('–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', 0),
                    '–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ': row.get('–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', 0),
                    '–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å': row.get('–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å', 0),
                    '–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å': row.get('–Ω–µ–∑–∞–∫–∞–∑–Ω—ã–µ_–ø—Ä–∏–±—ã–ª—å', 0)
                    
                })
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
        html_content = self._generate_html(data_by_branch)
        
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(html_content)
        
        print(f"‚úÖ –î–∞—à–±–æ—Ä–¥ Pro —Å–æ–∑–¥–∞–Ω: {filepath}")
        return filepath
        
    def _generate_html(self, data_by_branch):
        import os
        
       # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
        possible_paths = [
            "dashboard_template.html",  # —Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞
            os.path.join("–º–æ–¥—É–ª–∏", "dashboard_template.html"),  # –ø–∞–ø–∫–∞ –º–æ–¥—É–ª–∏
            os.path.join(os.path.dirname(__file__), "dashboard_template.html")  # —Ä—è–¥–æ–º —Å —Ñ–∞–π–ª–æ–º .py
        ]

        template_path = None
        for path in possible_paths:
            if os.path.exists(path):
                template_path = path
                print(f"‚úÖ –ù–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω: {path}")
                break

        if not template_path:
            print(f"‚ùå –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–∫–∞–ª –≤:")
            for path in possible_paths:
                exists = "‚úÖ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" if os.path.exists(path) else "‚ùå –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
                print(f"   ‚Ä¢ {path} ({exists})")
            return "<html><body><h1>–®–∞–±–ª–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω</h1></body></html>"
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —à–∞–±–ª–æ–Ω
        with open(template_path, "r", encoding="utf-8") as f:
            template = f.read()
        
        print(f"‚úÖ –®–∞–±–ª–æ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω: {len(template)} —Å–∏–º–≤–æ–ª–æ–≤")
        
        # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        data_json = json.dumps(data_by_branch, ensure_ascii=False)
        passwords_json = json.dumps(self.passwords)
        period = self.dm.report_period if hasattr(self.dm, 'report_period') else "–î–µ–∫–∞–±—Ä—å 2025"
        
        # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º JSON –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –≤—Å—Ç–∞–≤–∫–∏ –≤ JavaScript
        data_json_escaped = data_json.replace('</script>', '<\\/script>')
        
        # –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
        result = template.replace("{period}", period)\
                         .replace("{data_json}", data_json_escaped)\
                         .replace("{passwords_json}", passwords_json)
        
        print(f"‚úÖ HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {len(result)} —Å–∏–º–≤–æ–ª–æ–≤")
        # –û—Ç–ª–∞–¥–∫–∞: –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        if data_by_branch and data_by_branch.get('bd1'):
            sample = data_by_branch['bd1'][0]
            print(f"üîç [DEBUG] –ü–æ–ª—è –≤ –¥–∞–Ω–Ω—ã—Ö: {list(sample.keys())}")
            print(f"üîç [DEBUG] –∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ: {sample.get('–∑–∞–∫–∞–∑–Ω—ã–µ_–∫–æ–ª–≤–æ', '–ù–ï–¢')}")
        return result

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
if __name__ == "__main__":
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    class MockDataManager:
        def __init__(self):
            self.report_period = "–î–µ–∫–∞–±—Ä—å 2025"
            self.calculations = {
                'by_employee': pd.DataFrame([
                    {
                        '–§–ò–û': '–ü–∞—Ä–∞–º–æ—à–∫–∏–Ω –°–µ—Ä–≥–µ–π –ë–æ—Ä–∏—Å–æ–≤–∏—á',
                        '–§–∏–ª–∏–∞–ª': '–ë–î4',
                        '–û—Ç–¥–µ–ª': '–î–≤–µ—Ä–∏-–ª–∞–º–∏–Ω–∞—Ç –ë–î4',
                        '–û—Ç—Ä–∞–±–æ—Ç–∞–Ω–æ_—á–∞—Å–æ–≤': 159.5,
                        '–ù–æ—Ä–º–∞_—á–∞—Å–æ–≤': 171.4,
                        '–õ–∏—á–Ω—ã–π_–ø–æ–∫–∞–∑–∞—Ç–µ–ª—å': 37022,
                        '–û–±—ã—á–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏': 27727,
                        '–ë–æ–Ω—É—Å–Ω–∞—è_–ø—Ä–∏–±—ã–ª—å_—á–µ–∫–∏': 8345,
                        '–ù–µ–ª–∏–∫–≤–∏–¥–Ω–∞—è_–≤—ã—Ä—É—á–∫–∞_—á–µ–∫–∏': 950,
                        '–û–ø—Ç–æ–≤–∞—è_–ø—Ä–∏–±—ã–ª—å': 1378,
                        '–†–æ–∑–Ω_–ø—Ä–æ—á–∞—è_–ø—Ä–∏–±—ã–ª—å': 3100,
                        '–ö–æ—ç—Ñ_–æ–±—ã—á–Ω—ã—Ö': 5,
                        '–ö–æ—ç—Ñ_–±–æ–Ω—É—Å–Ω—ã—Ö': 10,
                        '–ö–æ—ç—Ñ_–Ω–µ–ª–∏–∫–≤–∏–¥–æ–≤': 2.5,
                        '–ö–æ—ç—Ñ_–æ–ø—Ç–æ–≤—ã—Ö': 2.5,
                        '–ó–∞—Ä–ø–ª–∞—Ç–∞_—Å_–º–∏–Ω–∏–º–∞–ª–∫–æ–π': 81500,
                        '–ü—Ä–∏–º–µ–Ω–µ–Ω–∞_–≥–∞—Ä–∞–Ω—Ç–∏—è': 90000,
                        '–†–∞–∑–Ω–∏—Ü–∞_–ø–æ_—á–∞—Å–∞–º': -6263,
                        '–ó–∞—Ä–ø–ª–∞—Ç–∞_–∏—Ç–æ–≥–æ': 83738,
                        '–î–æ–ª—è': 0.1866,
                        '–î–æ–ª_–ø—Ä–µ–º': 0
                    }
                ])
            }
    
    dm = MockDataManager()
    dashboard = ManagerDashboardPro(dm)
    dashboard.generate("test_dashboard_pro.html")
